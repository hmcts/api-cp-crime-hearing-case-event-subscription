openapi: 3.1.0

info:
  title: Client Subscriptions API
  description: API for managing client subscriptions as standalone resources.
  version: 1.0.0
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT
  contact:
    name: HMCTS API Marketplace
    email: no-reply@hmcts.com


servers:
  - url: https://api.example.com

security:
  - bearerAuth: []

tags:
  - name: Subscription

paths:
  /client-subscriptions:
    post:
      summary: Create a new client subscription
      description: Creates a new client subscription with the specified notification endpoint and event types.
      operationId: createClientSubscription
      tags:
        - Subscription
      requestBody:
        required: true
        content:
          application/json:
            examples:
              createSubscription:
                summary: Example subscription creation request
                value:
                  notificationEndpoint:
                    webhookUrl: "https://client.example.com/events"
                  eventTypes: ["PCR", "CUSTODIAL_RESULT"]
            schema:
              $ref: '#/components/schemas/ClientSubscriptionRequest'
      responses:
        '201':
          description: Subscription created
          content:
            application/json:
              examples:
                createdSubscription:
                  summary: Example subscription creation response
                  value:
                    clientSubscriptionId: "aa12f3dd-4cc1-4da7-b9ea-552fa3b9bc44"
                    notificationEndpoint:
                      webhookUrl: "https://client.example.com/events"
                    eventTypes: ["PCR", "CUSTODIAL_RESULT"]
                    createdAt: "2025-01-01T10:00:00Z"
                    updatedAt: null
              schema:
                $ref: '#/components/schemas/ClientSubscription'

        '400':
          description: Invalid request payload
          content:
            application/json:
              examples:
                invalidPayload:
                  value:
                    error: "invalid_request"
                    message: "eventTypes must contain at least one value."

        '401':
          description: Unauthorized


  /client-subscriptions/{clientSubscriptionId}:
    get:
      summary: Retrieve a client subscription by ID
      description: Returns the subscription matching the given clientSubscriptionId.
      operationId: getClientSubscription
      tags:
        - Subscription
      parameters:
        - name: clientSubscriptionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: "aa12f3dd-4cc1-4da7-b9ea-552fa3b9bc44"
      responses:
        '200':
          description: Subscription object
          content:
            application/json:
              examples:
                subscription:
                  value:
                    clientSubscriptionId: "aa12f3dd-4cc1-4da7-b9ea-552fa3b9bc44"
                    notificationEndpoint:
                      webhookUrl: "https://client.example.com/events"
                    eventTypes: ["PCR"]
                    createdAt: "2025-01-01T10:00:00Z"
                    updatedAt: "2025-01-05T17:30:00Z"
              schema:
                $ref: '#/components/schemas/ClientSubscription'

        '404':
          description: Subscription not found
          content:
            application/json:
              examples:
                notFound:
                  value:
                    error: "not_found"
                    message: "No subscription exists for ID aa12f3dd-4cc1-4da7-b9ea-552fa3b9bc44."

        '401':
          description: Unauthorized


    put:
      summary: Strict update of a client subscription
      description: Caller must supply *all* updatable fields.
      operationId: updateClientSubscription
      tags:
        - Subscription
      parameters:
        - name: clientSubscriptionId
          in: path
          required: true
          example: "aa12f3dd-4cc1-4da7-b9ea-552fa3b9bc44"
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            examples:
              updateSubscription:
                summary: Example update request
                value:
                  notificationEndpoint:
                    webhookUrl: "https://client.example.com/new-hook"
                  eventTypes: ["CUSTODIAL_RESULT"]
            schema:
              $ref: '#/components/schemas/ClientSubscriptionRequest'
      responses:
        '200':
          description: Subscription updated
          content:
            application/json:
              examples:
                updatedSubscription:
                  value:
                    clientSubscriptionId: "aa12f3dd-4cc1-4da7-b9ea-552fa3b9bc44"
                    notificationEndpoint:
                      webhookUrl: "https://client.example.com/new-hook"
                    eventTypes: ["CUSTODIAL_RESULT"]
                    createdAt: "2025-01-01T10:00:00Z"
                    updatedAt: "2025-01-10T09:15:00Z"
              schema:
                $ref: '#/components/schemas/ClientSubscription'

        '400':
          description: Invalid request

        '404':
          description: Subscription not found

        '401':
          description: Unauthorized


    delete:
      summary: Delete a subscription by ID
      description: Deletes the subscription identified by clientSubscriptionId.
      operationId: deleteClientSubscription
      tags:
        - Subscription
      parameters:
        - name: clientSubscriptionId
          in: path
          required: true
          example: "aa12f3dd-4cc1-4da7-b9ea-552fa3b9bc44"
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Deleted successfully

        '404':
          description: Subscription not found

        '401':
          description: Unauthorized


components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    EventType:
      type: string
      enum:
        - PCR
        - CUSTODIAL_RESULT

    NotificationEndpoint:
      type: object
      required:
        - webhookUrl
      properties:
        webhookUrl:
          type: string
          pattern: '^https://.*$'

    ClientSubscriptionRequest:
      type: object
      required:
        - notificationEndpoint
        - eventTypes
      properties:
        notificationEndpoint:
          $ref: '#/components/schemas/NotificationEndpoint'
        eventTypes:
          type: array
          minItems: 1
          maxItems: 2
          items:
            $ref: '#/components/schemas/EventType'

    ClientSubscription:
      type: object
      required:
        - clientSubscriptionId
        - notificationEndpoint
        - eventTypes
        - createdAt
      properties:
        clientSubscriptionId:
          type: string
          format: uuid
        notificationEndpoint:
          $ref: '#/components/schemas/NotificationEndpoint'
        eventTypes:
          type: array
          items:
            $ref: '#/components/schemas/EventType'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type:
            - string
          format: date-time

    PcrEventPayload:
      type: object
      description: >
        Payload representing a stored PCR document event with defendants and case details.
      required:
        - eventId
        - eventType
        - timestamp
        - defendants
      properties:
        eventId:
          type: string
          format: uuid
          description: Unique identifier of the stored PCR document event

        eventType:
          type: string
          description: Type of the event, e.g., PRISON_COURT_REGISTER_GENERATED
          $ref: '#/components/schemas/EventType'

        timestamp:
          type: string
          format: date-time
          description: Timestamp when the event occurred

        defendants:
          type: array
          description: List of defendants associated with this event
          items:
            type: object
            required:
              - masterDefendantId
              - name
              - dateOfBirth
            properties:
              masterDefendantId:
                type: string
                description: Unique identifier for the master defendant

              name:
                type: string
                description: Full name of the defendant

              dateOfBirth:
                type: string
                format: date
                description: Date of birth of the defendant

              custodyEstablishmentDetails:
                type: object
                description: Details of the custody establishment
                properties:
                  emailAddress:
                    type: string
                    format: email
                    description: Email address of the prison

              cases:
                type: array
                description: List of cases associated with the defendant
                items:
                  type: object
                  required:
                    - urn
                    - documents
                  properties:
                    urn:
                      type: string
                      description: Case URN associated with the defendant

                    documents:
                      type: array
                      description: List of documents for this case
                      items:
                        type: object
                        required:
                          - url
                          - timestamp
                        properties:
                          url:
                            type: string
                            format: uri
                            description: Secure URL to access the document

                          timestamp:
                            type: string
                            format: date-time
                            description: Timestamp when the document was generated

